<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The Buddy System</title>

    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <link rel="stylesheet" type="text/css" href="style/front.css">
    <link rel="stylesheet" type="text/css" href="style/game.css">
  </head>

  <body>
    <div id="waiting" class="site-wrapper">
      <div class="site-wrapper-inner">
        <div class="cover-container">
          <div class="inner cover">
            <h1 id="gameid" class="cover-heading"></h1>
            <p id="gameurl" class="lead"></p>
            <br>
            <p class="lead"> Waiting for another player to begin...</p>
          </div>
        </div>
      </div>
    </div>
    <div id="map"></div>
    <div id="win-state">
      <h1>You won!</h1>
      <form action="reset" method="get">
        <button type="submit">Back</button>
      </form>
    </div>

    <div id="street-view"></div>

    <script>
      var socket = io();
      var panorama;
      var sv;
      var map;

      function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,
        function(m,key,value) {
          vars[key] = value;
        });
        return vars;
      }

      var gameid = getUrlVars()['id'];
      $("h1#gameid").text("Game ID: "+gameid);
      $("p#gameurl").text(window.location.href);
      socket.emit('join', gameid);

      /* Send the new location to the server */
      function update_location() {
        pos = panorama.getPosition();
        socket.emit("update", {lat : pos.lat(), lng : pos.lng()});
      }

      /* Start the game and create the panorama */
      function start(location, radius) {
        /* Hide the waiting information, show the street view */
        $("#waiting").hide();
        $("#street-view").show();

        sv = new google.maps.StreetViewService();
        panorama = new google.maps.StreetViewPanorama(document.getElementById('street-view'));

        sv.getPanorama(
          {location: location,
           preference: google.maps.StreetViewPreference.NEAREST,
           radius: radius,
           source: google.maps.StreetViewSource.OUTDOOR
          },
          function (data, status) {
            panorama.setPano(data.location.pano);
            panorama.setPov({
              heading: 0,
              pitch: 0
            });
            panorama.setVisible(true);
          });

        panorama.addListener('position_changed', update_location);
      }

      /* The game was won. Reset. */
      function stop(time, history1, history2) {
        $("#street-view").hide();
        $("#win-state").show();
        $("#map").show();
        console.log("STOP");

        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 3,
          center: {lat: 0, lng: -180},
          mapTypeId: google.maps.MapTypeId.TERRAIN
        });

        console.log(history1.length);
        console.log(history2.length);

        var player1 = new google.maps.Polyline({
            path: history1,
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
          });

        var player2 = new google.maps.Polyline({
            path: history2,
            geodesic: true,
            strokeColor: '#0000FF',
            strokeOpacity: 1.0,
            strokeWeight: 2
          });

        player1.setMap(map);
        player2.setMap(map);

        // TODO: Any computation or statistics to show the player
      }

      socket.on("start", start);
      socket.on("stop", stop);
    </script>

    <script async defer
         src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDl2SdR82boZTM1ATkRUxOteVqD17EcCq4&signed_in=true">
    </script>
  </body>
</html>
