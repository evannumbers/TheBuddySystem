<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The Buddy System</title>
    <link rel="stylesheet" type="text/css" href="style/game.css">

    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  </head>

  <body>
    <div id="waiting">
      Waiting To Start...
    </div>

    <div id="win-state">
      You won!<br>
      <form action="reset" method="get">
        <button type="submit">Back</button>
      </form>
    </div>

    <div id="street-view"></div>

    <script>
      var socket = io();
      var panorama;

      function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,
        function(m,key,value) {
          vars[key] = value;
        });
        return vars;
      }

      var gameid = getUrlVars()['id'];
      socket.emit('join', gameid);

      /* Send the new location to the server */
      function update_location() {
        pos = panorama.getPosition();
        socket.emit("position_change", {lat : pos.lat(), lng : pos.lng()});
      }

      /* Start the game and create the panorama */
      function start(location, radius) {
        /* Hide the waiting information, show the street view */
        $("waiting").hide();
        $("street-view").show();

        panorama = new google.maps.StreetViewPanorama(document.getElementById('street-view'));

        google.maps.getPanorama(\
          google.maps.StreetViewLocationRequest(\
            location,
            google.maps.StreetViewPreference.NEAREST,
            radius,
            google.maps.StreetViewSource.OUTDOOR),
          function (data, status) {
            panorama.setPano(data.location.pano);
            panorama.setPov({
              heading: 0,
              pitch: 0
            });
            panorama.setVisible(true);
          });
      }

      /* The game was won. Reset. */
      function stop(time) {
        $("street-view").hide();
        $("win-state").show();

        // TODO: Any computation or statistics to show the player
      }

      socket.on("start", start);
      socket.on("stop", stop);
    </script>

    <script async defer
         src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDl2SdR82boZTM1ATkRUxOteVqD17EcCq4&signed_in=true&callback=initialize">
    </script>
  </body>
</html>
